import telebot
from telebot import types
import requests
from bs4 import BeautifulSoup
import re
import os
import psycopg2
from flask import Flask, request

# ================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ==================
BOT_TOKEN = os.environ.get("BOT_TOKEN")
ADMIN_ID = 6690559792 
CHANNEL_ID = "@banehstoore"
WHATSAPP = "09180514202"
PHONE_NUMBER = "09180514202"
MAP_URL = "https://maps.app.goo.gl/eWv6njTbL8ivfbYa6"
# Ø­ØªÙ…Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø¯Ø± Render Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
RENDER_URL = "https://telegram-bot-6-1qt1.onrender.com" 
DATABASE_URL = os.environ.get("DATABASE_URL")

bot = telebot.TeleBot(BOT_TOKEN, threaded=True)
app = Flask(__name__)
HEADERS = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36"}

# ================== Ù…Ø¯ÛŒØ±ÛŒØª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ==================
def get_db_connection():
    return psycopg2.connect(DATABASE_URL)

def save_user(user_id):
    try:
        conn = get_db_connection(); cur = conn.cursor()
        cur.execute('CREATE TABLE IF NOT EXISTS users (user_id BIGINT PRIMARY KEY)')
        cur.execute('INSERT INTO users (user_id) VALUES (%s) ON CONFLICT (user_id) DO NOTHING', (user_id,))
        conn.commit(); cur.close(); conn.close()
    except Exception as e: print(f"DB Error: {e}")

def get_all_users():
    try:
        conn = get_db_connection(); cur = conn.cursor()
        cur.execute('SELECT user_id FROM users')
        users = [row[0] for row in cur.fetchall()]
        cur.close(); conn.close()
        return users
    except: return []

# ================== Ù…Ù†ÙˆÙ‡Ø§ ==================
def get_main_keyboard(user_id):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("ğŸ›’ Ù…Ø­ØµÙˆÙ„Ø§Øª", "ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„")
    markup.row("ğŸ“¦ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ ØªÙ…Ø§Ø³")
    markup.row("ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡")
    if user_id == ADMIN_ID: markup.row("ğŸ›  Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª")
    return markup

# ================== Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ==================

@bot.message_handler(commands=['start'])
def start(message):
    save_user(message.from_user.id)
    bot.send_message(message.chat.id, "ğŸ‘‹ Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¨Ø§Ù†Ù‡ Ø§Ø³ØªÙˆØ± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\nÚ†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ú©Ù…Ú©ØªØ§Ù† Ú©Ù†Ù…ØŸ", 
                     reply_markup=get_main_keyboard(message.from_user.id))

@bot.message_handler(func=lambda m: m.text == "ğŸ›’ Ù…Ø­ØµÙˆÙ„Ø§Øª")
def products_btn(message):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("ğŸ› Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª", url="https://banehstoore.ir/products"))
    bot.send_message(message.chat.id, "ğŸ›’ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ø± Ø³Ø§ÛŒØª Ø¨Ø§Ù†Ù‡ Ø§Ø³ØªÙˆØ±:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸ“¦ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´")
def track_start(message):
    msg = bot.send_message(message.chat.id, "ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    bot.register_next_step_handler(msg, track_process)

def track_process(message):
    order_id = message.text.strip()
    if order_id.isdigit():
        track_url = f"https://banehstoore.ir/profile/order-details/{order_id}/"
        bot.send_message(message.chat.id, f"ğŸ“‘ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ± Ùˆ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡ {order_id} Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:\n\nğŸŒ {track_url}")
    else:
        bot.send_message(message.chat.id, "âŒ Ù„Ø·ÙØ§ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")

@bot.message_handler(func=lambda m: m.text == "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ ØªÙ…Ø§Ø³")
def support_btn(message):
    bot.send_message(message.chat.id, f"ğŸ“ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: {PHONE_NUMBER}\nğŸ’¬ ÙˆØ§ØªØ³Ø§Ù¾: https://wa.me/98{WHATSAPP[1:]}")

@bot.message_handler(func=lambda m: m.text == "ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡")
def channel_btn(message):
    bot.send_message(message.chat.id, f"ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø§:\n{CHANNEL_ID}")

# ================== ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Flask ==================

@app.route('/' + BOT_TOKEN, methods=['POST'])
def getMessage():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return "!", 200
    else:
        return "Error", 403

@app.route("/")
def webhook():
    # Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ù…Ø­Ø¶ Ø¨Ø§Ø² Ø´Ø¯Ù† Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±ØŒ Ø§ØªØµØ§Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    bot.remove_webhook()
    status = bot.set_webhook(url=RENDER_URL + '/' + BOT_TOKEN)
    if status:
        return f"<h1>Bot is Active!</h1><p>Webhook set to: {RENDER_URL}</p>", 200
    else:
        return "<h1>Webhook Failed!</h1>", 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 10000)))
